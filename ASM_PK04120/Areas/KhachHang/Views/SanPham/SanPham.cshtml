@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@model ASM_PK04120.Areas.KhachHang.Models.SanPhamViewModel
@{
    Layout = "~/Areas/KhachHang/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "Trang sản phẩm";
}


<section class="ftco-menu mb-5 pb-5">
    <div class="container">
        <div class="row justify-content-center mb-5">
            <div class="col-md-7 heading-section text-center ftco-animate">
                <span class="subheading">Khám Phá</span>
                <br>
                <h2 class="mb-4">Sản Phẩm Của Chúng Tôi</h2>
                <p>Ở một nơi rất xa, đằng sau những ngọn núi chữ, xa khỏi các quốc gia Vokalia và Consonantia, có những văn bản vô nghĩa sinh sống.</p>
            </div>
        </div>
        <div class="row d-md-flex">
            <div class="col-lg-12 ftco-animate p-md-5">
                <div class="row">
                    <div class="col-md-3">
                        @if (Model.MaDanhMucHienTai.HasValue)
                        {
                            <input type="hidden" name="maDanhMuc" value="@Model.MaDanhMucHienTai" />
                        }
                        <div class="sidebar-box">
                            <h3 class="sidebar-heading">Lọc Theo Giá</h3>
                            <div class="form-group">
                                <div class="form-group">
                                    <div class="select-wrap">
                                        <div class="icon"><span class="ion-ios-arrow-down"></span></div>
                                        <select class="form-control" id="priceFilter">
                                            <option value="all">Tất cả mức giá</option>
                                            <option value="0-100000">Dưới 100,000 VNĐ</option>
                                            <option value="100000-200000">100,000 - 200,000 VNĐ</option>
                                            <option value="200000-300000">200,000 - 300,000 VNĐ</option>
                                            <option value="300000-9999999">Trên 300,000 VNĐ</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="sidebar-box">
                            <h3 class="sidebar-heading">Sắp Xếp</h3>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sortOrder" id="sortNewest" value="newest" checked>
                                <label class="form-check-label" for="sortNewest">Mới nhất</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sortOrder" id="sortPriceAsc" value="priceAsc">
                                <label class="form-check-label" for="sortPriceAsc">Giá: Thấp đến Cao</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="sortOrder" id="sortPriceDesc" value="priceDesc">
                                <label class="form-check-label" for="sortPriceDesc">Giá: Cao đến Thấp</label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-9 nav-link-wrap mb-5">
                        <div class="nav ftco-animate nav-pills justify-content-center" id="category-filter" role="tablist" aria-orientation="vertical">
                            <a class="nav-link category-link @(Model.MaDanhMucHienTai == null ? "active" : "")" href="#" data-id="">Tất cả</a>
                            @foreach (var danhMuc in Model.DanhSachDanhMuc)
                            {
                                <a class="nav-link category-link @(Model.MaDanhMucHienTai == danhMuc.MaDanhMuc ? "active" : "")" href="#" data-id="@danhMuc.MaDanhMuc">@danhMuc.TenDanhMuc</a>
                            }
                        </div>

						<div id="product-list-container">
							@await Html.PartialAsync("_dsSanPhamPartial", Model)
						</div>
						
                    </div>
                    
                </div>
            </div>

        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
			// Lấy các phần tử cần thiết
            const productContainer = document.getElementById('product-list-container');
            const priceFilter = document.getElementById('priceFilter');
            const sortRadios = document.querySelectorAll('input[name="sortOrder"]');
            const categoryLinksContainer = document.getElementById('category-filter');

            function fetchProducts(page = 1) {
				// Lấy các giá trị lọc
                const priceRange = priceFilter.value;
                const sortOrder = document.querySelector('input[name="sortOrder"]:checked').value;
                const activeCategory = categoryLinksContainer.querySelector('.category-link.active');
                const categoryId = activeCategory ? activeCategory.getAttribute('data-id') : '';

				// Tạo URL với các tham số
                const url = `/KhachHang/SanPham/_FilterProductsPartial?maDanhMuc=${categoryId}&phamViGia=${priceRange}&thuTuSapXep=${sortOrder}&trang=${page}`;

				// Hiệu ứng tải
                productContainer.style.opacity = '0.5';

                fetch(url)
                    .then(response => response.text())
                    .then(html => {
                        // Cập nhật nội dung
                        productContainer.innerHTML = html;
                        productContainer.style.opacity = '1';

                        // --- PHẦN SỬA LỖI QUAN TRỌNG ---
                        // Tìm tất cả các sản phẩm mới có class ftco-animate và kích hoạt chúng
                        const newAnimatedItems = productContainer.querySelectorAll('.ftco-animate');
                        if(newAnimatedItems.length > 0) {
                            newAnimatedItems.forEach(item => {
                                // Thêm các class để kích hoạt hiệu ứng fade-in-up
                                item.classList.add('fadeInUp', 'ftco-animated');
                            });
                        }
                        // -----------------------------
                    })
                    .catch(error => {
                        console.error('Lỗi khi lọc sản phẩm:', error);
                        productContainer.style.opacity = '1';
                    });
            }

			// Gán sự kiện thay đổi cho các bộ lọc
            priceFilter.addEventListener('change', () => fetchProducts(1));
            sortRadios.forEach(radio => radio.addEventListener('change', () => fetchProducts(1)));
            categoryLinksContainer.addEventListener('click', function (event) {
				// Chỉ xử lý khi click vào thẻ a
                const link = event.target.closest('.category-link');

				// Nếu có thẻ a được click
                if (link) {
                    event.preventDefault();
                    categoryLinksContainer.querySelector('.category-link.active').classList.remove('active');
                    link.classList.add('active');
                    fetchProducts(1);
                }
            });
			// Xử lý phân trang
            productContainer.addEventListener('click', function (event) {
				// Chỉ xử lý khi click vào thẻ a trong phân trang
                const pageLink = event.target.closest('.block-27 a');

				// Nếu có thẻ a được click
                if (pageLink) {
                    event.preventDefault();
                    const page = pageLink.getAttribute('data-page');
                    fetchProducts(page);
                }
            });
        });
    </script>
}